name: Build and Release

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            musl_target: x86_64-linux-musl
          - target: aarch64-unknown-linux-musl
            musl_target: aarch64-linux-musl

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install musl tools
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Install musl cross compiler
      if: matrix.target == 'aarch64-unknown-linux-musl'
      run: |
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Install Rust toolchains
      run: |
        rustup toolchain install stable
        rustup toolchain install nightly --component rust-src
        rustup target add --toolchain stable ${{ matrix.target }}

    - name: Install bpf-linker
      run: cargo install bpf-linker --locked

    - name: Build release binary
      run: cargo build --package rfw --release --target ${{ matrix.target }}
      env:
        CC: ${{ matrix.target == 'aarch64-unknown-linux-musl' && 'aarch64-linux-gnu-gcc' || 'musl-gcc' }}
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc

    - name: Prepare binary
      run: |
        mkdir -p artifacts
        cp target/${{ matrix.target }}/release/rfw artifacts/rfw-${{ matrix.target }}
        chmod +x artifacts/rfw-${{ matrix.target }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v5
      with:
        name: rfw-${{ matrix.target }}
        path: artifacts/rfw-${{ matrix.target }}

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download all artifacts
      uses: actions/download-artifact@v5
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        # 将所有二进制文件移到artifacts根目录
        find artifacts -name 'rfw-*' -type f -exec mv {} artifacts/ \;

        # 删除空的子目录
        find artifacts -type d -empty -delete

        # 创建统一的checksums文件
        cd artifacts
        sha256sum rfw-* > checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/rfw-*
          artifacts/checksums.txt
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Installation

          Download the binary for your platform:

          ```bash
          # For x86_64 (Intel/AMD)
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/rfw-x86_64-unknown-linux-musl
          chmod +x rfw-x86_64-unknown-linux-musl
          sudo mv rfw-x86_64-unknown-linux-musl /usr/local/bin/rfw

          # For ARM64 (Raspberry Pi, AWS Graviton, etc.)
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/rfw-aarch64-unknown-linux-musl
          chmod +x rfw-aarch64-unknown-linux-musl
          sudo mv rfw-aarch64-unknown-linux-musl /usr/local/bin/rfw
          ```

          ## Usage

          ```bash
          # Basic usage - block all China inbound traffic
          sudo rfw --iface eth0 --block-cn-all

          # Block specific protocols from China
          sudo rfw --iface eth0 --block-cn-http --block-cn-socks5

          # Block email sending
          sudo rfw --iface eth0 --block-email
          ```

          ## Requirements

          - Linux kernel 5.15+ with XDP support
          - Root privileges to attach XDP programs
          - Network interface with XDP driver support

          ## Verify checksums

          ```bash
          sha256sum -c checksums.txt
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
